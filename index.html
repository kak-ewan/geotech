<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>AR Geolokasi Explorer</title>
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        html, body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: none;
        }
        .ar-scene { 
            position: fixed !important; 
            top: 0 !important; 
            left: 0 !important; 
            width: 100vw !important; 
            height: 100vh !important;
            height: 100dvh !important;
            z-index: 1 !important;
            border: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: transparent !important;
        }
        .ui-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh;
            height: 100dvh;
            z-index: 10; 
            pointer-events: none; 
        }
        .ui-overlay > * { pointer-events: auto; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        /* Loading Styles */
        .camera-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            text-align: center;
            padding: 20px;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-container {
            width: 80%;
            max-width: 300px;
            margin-top: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        .retry-button {
            margin-top: 20px;
            background: #ff4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            display: none;
        }
        
        /* Navigation UI Styles */
        .navigation-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 15;
            pointer-events: none;
        }
        .direction-arrow {
            width: clamp(60px, 15vw, 80px);
            height: clamp(60px, 15vw, 80px);
            background: linear-gradient(135deg, #4285f4, #34a853);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(66, 133, 244, 0.4);
            transition: transform 0.3s ease;
        }
        .direction-arrow::before {
            content: '‚Üë';
            font-size: 32px;
            color: white;
            font-weight: bold;
        }
        .navigation-info {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: clamp(8px, 3vw, 12px) clamp(12px, 5vw, 20px);
            border-radius: 25px;
            margin-top: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            font-size: clamp(12px, 3.5vw, 16px);
            max-width: 90vw;
        }
        
        /* Compass Styles */
        .compass-ring {
            position: fixed;
            top: clamp(80px, 20vh, 100px);
            right: clamp(10px, 4vw, 20px);
            width: clamp(45px, 12vw, 60px);
            height: clamp(45px, 12vw, 60px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 12;
            font-size: clamp(8px, 2.5vw, 12px);
        }
        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 20px;
            background: #ff4444;
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
            transition: transform 0.3s ease;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 400px;
            width: 100%;
            overflow: hidden;
        }
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            font-size: 18px;
        }
        .modal-body {
            padding: 16px;
        }
        .modal-footer {
            padding: 16px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal-button {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-button-primary {
            background: #667eea;
            color: white;
        }
        .modal-button-secondary {
            background: #eee;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="camera-loading">
        <div class="loading-spinner"></div>
        <div id="loadingMessage">Menyiapkan aplikasi...</div>
        <div class="progress-container">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressText">0%</div>
        </div>
        <button id="retryButton" class="retry-button">Coba Lagi</button>
    </div>

    <!-- Halaman Awal -->
    <div id="homePage" class="min-h-screen gradient-bg flex items-center justify-center hidden">
        <div class="text-center text-white px-6">
            <div class="mb-8">
                <h1 class="text-5xl font-bold mb-4">üåç AR Explorer</h1>
                <p class="text-xl opacity-90">Jelajahi dunia dengan Augmented Reality</p>
            </div>
            <button id="exploreBtn" class="bg-white text-purple-600 px-8 py-4 rounded-full text-lg font-semibold hover:bg-gray-100 transform hover:scale-105 transition-all duration-200 shadow-lg">
                üöÄ Mulai Jelajah
            </button>
        </div>
    </div>

    <!-- Halaman AR -->
    <div id="arPage" class="hidden">
        <!-- AR Scene -->
        <a-scene 
            id="arScene"
            class="ar-scene"
            embedded 
            arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
            vr-mode-ui="enabled: false"
            renderer="logarithmicDepthBuffer: true;"
            loading-screen="enabled: false">
            
            <a-camera 
                id="arCamera"
                gps-camera 
                rotation-reader
                look-controls-enabled="false"
                arjs-look-controls="smoothingFactor: 0.1">
            </a-camera>
        </a-scene>

        <!-- UI Overlay -->
        <div class="ui-overlay">
            <!-- Header Controls -->
            <div class="flex justify-between items-center p-2 sm:p-4 safe-area-inset-top">
                <button id="backBtn" class="bg-black bg-opacity-50 text-white p-2 sm:p-3 rounded-full hover:bg-opacity-70 transition-all text-sm sm:text-base min-h-[44px] min-w-[44px] flex items-center justify-center">
                    <span class="hidden sm:inline">‚Üê Kembali</span>
                    <span class="sm:hidden">‚Üê</span>
                </button>
                <button id="helpBtn" class="bg-black bg-opacity-50 text-white p-2 sm:p-3 rounded-full hover:bg-opacity-70 transition-all text-sm sm:text-base min-h-[44px] min-w-[44px] flex items-center justify-center">
                    <span class="hidden sm:inline">‚ùì Bantuan</span>
                    <span class="sm:hidden">‚ùì</span>
                </button>
            </div>

            <!-- Status Info -->
            <div id="statusInfo" class="absolute top-16 sm:top-20 left-2 sm:left-4 right-2 sm:right-auto bg-black bg-opacity-50 text-white p-2 sm:p-3 rounded-lg text-sm sm:text-base max-w-xs">
                <div class="flex items-center space-x-2">
                    <div class="loading-spinner"></div>
                    <span class="truncate">Memuat lokasi...</span>
                </div>
            </div>

            <!-- Distance Info -->
            <div id="distanceInfo" class="absolute bottom-16 sm:bottom-20 left-2 sm:left-4 right-2 sm:right-4 bg-black bg-opacity-50 text-white p-2 sm:p-3 rounded-lg hidden safe-area-inset-bottom">
                <div class="text-center">
                    <div class="text-xs sm:text-sm opacity-75">Objek terdekat:</div>
                    <div id="nearestObject" class="font-semibold text-sm sm:text-base truncate"></div>
                    <div id="nearestDistance" class="text-xs sm:text-sm"></div>
                </div>
            </div>

            <!-- Navigation Overlay -->
            <div id="navigationOverlay" class="navigation-overlay hidden">
                <div class="pulse-ring"></div>
                <div id="directionArrow" class="direction-arrow"></div>
                <div class="navigation-info">
                    <div id="navDestination" class="font-semibold text-lg"></div>
                    <div id="navDistance" class="text-sm opacity-75"></div>
                    <div id="navDirection" class="text-xs mt-1"></div>
                </div>
            </div>

            <!-- Compass -->
            <div class="compass-ring">
                <div id="compassNeedle" class="compass-needle"></div>
                <div class="absolute inset-0 flex items-center justify-center text-white text-xs font-bold">N</div>
            </div>

            <!-- Navigation Controls -->
            <div id="navControls" class="absolute bottom-2 sm:bottom-4 left-2 sm:left-4 right-2 sm:right-4 hidden safe-area-inset-bottom">
                <div class="flex justify-center space-x-2 sm:space-x-4">
                    <button id="stopNavBtn" class="bg-red-500 text-white px-3 sm:px-6 py-2 sm:py-3 rounded-full hover:bg-red-600 transition-colors text-sm sm:text-base min-h-[44px] flex items-center">
                        <span class="hidden sm:inline">üõë Berhenti</span>
                        <span class="sm:hidden">üõë</span>
                    </button>
                    <button id="recenterBtn" class="bg-blue-500 text-white px-3 sm:px-6 py-2 sm:py-3 rounded-full hover:bg-blue-600 transition-colors text-sm sm:text-base min-h-[44px] flex items-center">
                        <span class="hidden sm:inline">üéØ Pusatkan</span>
                        <span class="sm:hidden">üéØ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Bantuan -->
    <div id="helpModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">üìç Objek Tersedia</div>
            <div class="modal-body">
                <div id="objectList" class="space-y-3">
                    <!-- Akan diisi dengan JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeHelpBtn" class="modal-button modal-button-secondary">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal Izin -->
    <div id="permissionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">üîê Izin Diperlukan</div>
            <div class="modal-body">
                <p>Aplikasi memerlukan akses kamera dan lokasi untuk fitur AR. Silakan berikan izin saat diminta.</p>
            </div>
            <div class="modal-footer">
                <button id="cancelPermissionBtn" class="modal-button modal-button-secondary">Batal</button>
                <button id="grantPermissionBtn" class="modal-button modal-button-primary">Berikan Izin</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let arObjects = [];
        let userLocation = null;
        let watchId = null;
        let arScene = null;
        let arCamera = null;
        let currentNavigation = null;
        let deviceOrientation = 0;
        let compassHeading = 0;
        let cameraStream = null;
        let isAndroid = /android/i.test(navigator.userAgent);

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const loadingMessage = document.getElementById('loadingMessage');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const retryButton = document.getElementById('retryButton');
        const homePage = document.getElementById('homePage');
        const arPage = document.getElementById('arPage');
        const exploreBtn = document.getElementById('exploreBtn');
        const backBtn = document.getElementById('backBtn');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        const permissionModal = document.getElementById('permissionModal');
        const grantPermissionBtn = document.getElementById('grantPermissionBtn');
        const cancelPermissionBtn = document.getElementById('cancelPermissionBtn');
        const statusInfo = document.getElementById('statusInfo');
        const distanceInfo = document.getElementById('distanceInfo');
        const objectList = document.getElementById('objectList');

        // Update loading UI
        function updateLoading(message, progress = 0) {
            loadingMessage.textContent = message;
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
            
            if (progress >= 100) {
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                }, 500);
            }
        }

        // Show error and retry button
        function showError(message) {
            loadingMessage.textContent = message;
            retryButton.classList.remove('hidden');
        }

        // Hide loading screen and show home page
        function showHomePage() {
            loadingScreen.classList.add('hidden');
            homePage.classList.remove('hidden');
        }

        // Load data from CSV
        async function loadCSVData() {
            try {
                updateLoading('Memuat data lokasi...', 10);
                const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSCPrAyjTP4O7lSWJnouA4Ysnd5U88mcM-dWyJG0Nv9eWOA3yVKrGJ1-5G_QDdEcTNpwn0F5XbzeUJh/pub?gid=0&single=true&output=csv';
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                const objects = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const [name, lat, lon, url] = line.split(',').map(item => item.trim());
                        if (name && lat && lon) {
                            objects.push({
                                name: name.replace(/"/g, ''),
                                lat: parseFloat(lat),
                                lon: parseFloat(lon),
                                url: url ? url.replace(/"/g, '') : ''
                            });
                        }
                    }
                }
                
                arObjects = objects;
                updateLoading('Data lokasi dimuat', 20);
                updateObjectList();
                showHomePage();
            } catch (error) {
                console.error('Error loading CSV data:', error);
                // Fallback data
                arObjects = [
                    { name: 'Monas', lat: -6.1754, lon: 106.8272, url: 'https://example.com/monas' },
                    { name: 'Bundaran HI', lat: -6.1944, lon: 106.8229, url: 'https://example.com/hi' }
                ];
                updateObjectList();
                showHomePage();
            }
        }

        // Update object list in help modal
        function updateObjectList() {
            objectList.innerHTML = '';
            arObjects.forEach((obj, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors min-h-[44px] flex flex-col justify-center';
                div.innerHTML = `
                    <div class="font-semibold text-sm sm:text-base truncate">${obj.name}</div>
                    <div class="text-xs sm:text-sm text-gray-600 truncate">Lat: ${obj.lat.toFixed(4)}, Lon: ${obj.lon.toFixed(4)}</div>
                `;
                div.onclick = () => navigateToObject(obj);
                objectList.appendChild(div);
            });
        }

        // Navigate to object
        function navigateToObject(obj) {
            helpModal.classList.add('hidden');
            if (userLocation) {
                currentNavigation = obj;
                startNavigation();
            }
        }

        // Start navigation
        function startNavigation() {
            if (!currentNavigation || !userLocation) return;

            const navigationOverlay = document.getElementById('navigationOverlay');
            const navControls = document.getElementById('navControls');
            const distanceInfo = document.getElementById('distanceInfo');
            
            navigationOverlay.classList.remove('hidden');
            navControls.classList.remove('hidden');
            distanceInfo.classList.add('hidden');
            
            updateNavigationDisplay();
        }

        // Stop navigation
        function stopNavigation() {
            currentNavigation = null;
            const navigationOverlay = document.getElementById('navigationOverlay');
            const navControls = document.getElementById('navControls');
            const distanceInfo = document.getElementById('distanceInfo');
            
            navigationOverlay.classList.add('hidden');
            navControls.classList.add('hidden');
            distanceInfo.classList.remove('hidden');
        }

        // Update navigation display
        function updateNavigationDisplay() {
            if (!currentNavigation || !userLocation) return;

            const distance = calculateDistance(userLocation.lat, userLocation.lon, currentNavigation.lat, currentNavigation.lon);
            const bearing = calculateBearing(userLocation.lat, userLocation.lon, currentNavigation.lat, currentNavigation.lon);
            
            // Update navigation info
            document.getElementById('navDestination').textContent = currentNavigation.name;
            document.getElementById('navDistance').textContent = `${(distance * 1000).toFixed(0)} meter`;
            
            // Update direction arrow
            const directionArrow = document.getElementById('directionArrow');
            const relativeBearing = bearing - deviceOrientation;
            directionArrow.style.transform = `rotate(${relativeBearing}deg)`;
            
            // Update direction text
            const directionText = getDirectionText(relativeBearing);
            document.getElementById('navDirection').textContent = directionText;
            
            // Check if arrived
            if (distance < 0.05) { // 50 meters
                showArrivalNotification();
            }
        }

        // Calculate bearing between two points
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            
            const y = Math.sin(dLon) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLon);
            
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            return (bearing + 360) % 360;
        }

        // Get direction text
        function getDirectionText(bearing) {
            const normalizedBearing = ((bearing % 360) + 360) % 360;
            
            if (normalizedBearing >= 337.5 || normalizedBearing < 22.5) return "Lurus ke depan";
            if (normalizedBearing >= 22.5 && normalizedBearing < 67.5) return "Belok kanan depan";
            if (normalizedBearing >= 67.5 && normalizedBearing < 112.5) return "Belok kanan";
            if (normalizedBearing >= 112.5 && normalizedBearing < 157.5) return "Belok kanan belakang";
            if (normalizedBearing >= 157.5 && normalizedBearing < 202.5) return "Putar balik";
            if (normalizedBearing >= 202.5 && normalizedBearing < 247.5) return "Belok kiri belakang";
            if (normalizedBearing >= 247.5 && normalizedBearing < 292.5) return "Belok kiri";
            if (normalizedBearing >= 292.5 && normalizedBearing < 337.5) return "Belok kiri depan";
        }

        // Show arrival notification
        function showArrivalNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white p-6 rounded-lg z-50 text-center';
            notification.innerHTML = `
                <div class="text-2xl mb-2">üéâ</div>
                <div class="font-bold text-lg">Tiba di Tujuan!</div>
                <div class="text-sm">${currentNavigation.name}</div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
                stopNavigation();
            }, 3000);
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Check camera support
        async function checkCameraSupport() {
            try {
                updateLoading('Memeriksa kamera...', 30);
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Browser tidak mendukung akses kamera');
                }
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const hasCamera = devices.some(device => device.kind === 'videoinput');
                
                if (!hasCamera) {
                    throw new Error('Tidak ditemukan kamera');
                }
                
                return true;
            } catch (error) {
                console.error('Camera check failed:', error);
                showError(`Error kamera: ${error.message}`);
                throw error;
            }
        }

        // Request camera access with timeout
        async function requestCameraAccess() {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout: Kamera tidak merespon'));
                }, 15000); // 15 detik timeout

                updateLoading('Mengakses kamera...', 40);
                
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                // Try back camera first
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        clearTimeout(timeout);
                        resolve(stream);
                    })
                    .catch(backError => {
                        console.log('Mencoba kamera depan...');
                        
                        // Fallback to front camera
                        constraints.video.facingMode = 'user';
                        navigator.mediaDevices.getUserMedia(constraints)
                            .then(stream => {
                                clearTimeout(timeout);
                                resolve(stream);
                            })
                            .catch(frontError => {
                                clearTimeout(timeout);
                                reject(new Error('Tidak dapat mengakses kamera depan maupun belakang'));
                            });
                    });
            });
        }

        // Request location permission
        async function requestLocationPermission() {
            return new Promise((resolve, reject) => {
                updateLoading('Meminta izin lokasi...', 60);
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        resolve(position);
                    },
                    error => {
                        console.error('Location error:', error);
                        reject(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });
        }

        // Start AR experience
        async function startAR() {
            try {
                // Reset UI
                retryButton.classList.add('hidden');
                loadingScreen.classList.remove('hidden');
                
                // Step 1: Check camera support
                await checkCameraSupport();
                
                // Step 2: Request camera access
                cameraStream = await requestCameraAccess();
                cameraStream.getTracks().forEach(track => track.stop());
                
                // Step 3: Request location permission
                await requestLocationPermission();
                
                // Step 4: Initialize AR
                updateLoading('Menyiapkan AR...', 80);
                homePage.classList.add('hidden');
                arPage.classList.remove('hidden');
                initializeAR();
                
                updateLoading('Siap!', 100);
            } catch (error) {
                console.error('AR initialization failed:', error);
                showError(`Gagal: ${error.message}`);
                
                // Clean up if any partial resources were acquired
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
            }
        }

        // Initialize AR components
        function initializeAR() {
            arScene = document.getElementById('arScene');
            arCamera = document.getElementById('arCamera');
            
            // Wait for A-Frame to be ready
            arScene.addEventListener('loaded', () => {
                console.log('AR Scene loaded');
                startLocationTracking();
                requestOrientationPermission();
            });
        }

        // Start location tracking
        function startLocationTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        updateARObjects();
                        updateNearestObject();
                        if (currentNavigation) {
                            updateNavigationDisplay();
                        }
                        statusInfo.innerHTML = `
                            <div class="text-green-400">
                                üìç Lokasi: ${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}
                            </div>
                        `;
                    },
                    (error) => {
                        console.error('Location tracking error:', error);
                        statusInfo.innerHTML = `
                            <div class="text-red-400">
                                ‚ùå Error lokasi: ${error.message}
                            </div>
                        `;
                    },
                    { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
                );
            }
        }

        // Request device orientation permission
        async function requestOrientationPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        startOrientationTracking();
                    }
                } catch (error) {
                    console.error('Orientation permission error:', error);
                }
            } else {
                startOrientationTracking();
            }
        }

        // Start orientation tracking
        function startOrientationTracking() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', (event) => {
                    let heading = event.alpha;
                    if (heading !== null) {
                        compassHeading = (360 - heading) % 360;
                        deviceOrientation = compassHeading;
                        
                        const compassNeedle = document.getElementById('compassNeedle');
                        if (compassNeedle) {
                            compassNeedle.style.transform = `translate(-50%, -100%) rotate(${compassHeading}deg)`;
                        }
                        
                        if (currentNavigation) {
                            updateNavigationDisplay();
                        }
                    }
                });
            }
        }

        // Update AR objects
        function updateARObjects() {
            if (!arScene || !userLocation) return;

            // Remove existing AR objects
            const existingObjects = arScene.querySelectorAll('[ar-object]');
            existingObjects.forEach(obj => obj.remove());

            // Add new AR objects
            arObjects.forEach((obj, index) => {
                const distance = calculateDistance(userLocation.lat, userLocation.lon, obj.lat, obj.lon);
                
                // Only show objects within 5km
                if (distance <= 5) {
                    const entity = document.createElement('a-text');
                    entity.setAttribute('ar-object', '');
                    entity.setAttribute('value', `${obj.name}\n${distance.toFixed(2)}km`);
                    entity.setAttribute('color', '#ffffff');
                    entity.setAttribute('background', 'color: rgba(0,0,0,0.7); opacity: 0.8');
                    entity.setAttribute('align', 'center');
                    entity.setAttribute('width', '6');
                    entity.setAttribute('gps-entity-place', `latitude: ${obj.lat}; longitude: ${obj.lon}`);
                    entity.setAttribute('look-at', '[gps-camera]');
                    
                    arScene.appendChild(entity);
                }
            });
        }

        // Update nearest object info
        function updateNearestObject() {
            if (!userLocation || arObjects.length === 0) return;

            let nearest = null;
            let minDistance = Infinity;

            arObjects.forEach(obj => {
                const distance = calculateDistance(userLocation.lat, userLocation.lon, obj.lat, obj.lon);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = obj;
                }
            });

            if (nearest) {
                document.getElementById('nearestObject').textContent = nearest.name;
                document.getElementById('nearestDistance').textContent = `${minDistance.toFixed(2)} km`;
                distanceInfo.classList.remove('hidden');
            }
        }

        // Clean up resources
        function cleanupResources() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        }

        // Event listeners
        exploreBtn.addEventListener('click', () => {
            permissionModal.classList.remove('hidden');
        });

        grantPermissionBtn.addEventListener('click', async () => {
            permissionModal.classList.add('hidden');
            await startAR();
        });

        cancelPermissionBtn.addEventListener('click', () => {
            permissionModal.classList.add('hidden');
        });

        retryButton.addEventListener('click', async () => {
            retryButton.classList.add('hidden');
            await startAR();
        });

        backBtn.addEventListener('click', () => {
            cleanupResources();
            arPage.classList.add('hidden');
            homePage.classList.remove('hidden');
        });

        helpBtn.addEventListener('click', () => {
            helpModal.classList.remove('hidden');
        });

        closeHelpBtn.addEventListener('click', () => {
            helpModal.classList.add('hidden');
        });

        document.getElementById('stopNavBtn').addEventListener('click', () => {
            stopNavigation();
        });

        document.getElementById('recenterBtn').addEventListener('click', () => {
            if (currentNavigation) {
                updateNavigationDisplay();
            }
        });

        // Close modals when clicking outside
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.classList.add('hidden');
            }
        });

        permissionModal.addEventListener('click', (e) => {
            if (e.target === permissionModal) {
                permissionModal.classList.add('hidden');
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Android specific optimizations
            if (isAndroid) {
                console.log('Perangkat Android terdeteksi');
                document.body.classList.add('android-fix');
            }
            
            // Start loading data
            loadCSVData();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                }
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
            } else if (arPage.style.display !== 'none') {
                if (!watchId) {
                    startLocationTracking();
                }
                startAR();
            }
        });
    </script>
</body>
</html>
