<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GeoTech AR</title>
<style>
  html, body {
    margin: 0; padding: 0;
    height: 100%;
    overflow: hidden;
    background: black;
    font-family: sans-serif;
  }
  #cameraFeed {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    z-index: 0;
    background: black;
  }
  #arrow {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 48px;
    color: white;
    text-shadow: 0 0 5px black;
    z-index: 2;
  }
  #distance {
    position: fixed;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    font-size: 18px;
    text-shadow: 0 0 5px black;
    z-index: 2;
  }
  #helpBtn {
    position: fixed;
    top: 10px; left: 10px;
    background: rgba(0,0,0,0.6);
    color: white;
    border: none;
    padding: 8px 12px;
    font-size: 14px;
    z-index: 3;
    cursor: pointer;
  }
  #helpPanel {
    position: fixed;
    top: 0; left: -250px;
    width: 250px; height: 100%;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 15px;
    transition: left 0.3s;
    z-index: 4;
    overflow-y: auto;
  }
  #helpPanel.open {
    left: 0;
  }
  .locationItem {
    padding: 8px;
    border-bottom: 1px solid #444;
    cursor: pointer;
  }
  .locationItem:hover {
    background: rgba(255,255,255,0.1);
  }
</style>
</head>
<body>

<!-- Kamera -->
<video id="cameraFeed" autoplay playsinline muted></video>

<!-- AR Overlay -->
<div id="arrow">⬆</div>
<div id="distance">Jarak: - m</div>

<!-- Menu -->
<button id="helpBtn">Bantuan</button>
<div id="helpPanel">
  <h3>Daftar Lokasi</h3>
  <div id="locationList">Memuat...</div>
</div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCPrAyjTP4O7lSWJnouA4Ysnd5U88mcM-dWyJG0Nv9eWOA3yVKrGJ1-5G_QDdEcTNpwn0F5XbzeUJh/pub?gid=0&single=true&output=csv";
let locations = [];
let target = null;
let currentPos = null;
let currentHeading = 0;

// Buka kamera
async function initCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    document.getElementById("cameraFeed").srcObject = stream;
  } catch (e) {
    alert("Gagal membuka kamera: " + e.message);
  }
}

// Ambil data lokasi dari CSV
async function loadLocations() {
  const res = await fetch(csvUrl);
  const text = await res.text();
  const rows = text.trim().split("\n").slice(1);
  locations = rows.map(r => {
    const [name, lat, lon, url] = r.split(",");
    return { name, lat: parseFloat(lat), lon: parseFloat(lon), url: url.trim() };
  });
  renderLocationList();
}

function renderLocationList() {
  const list = document.getElementById("locationList");
  list.innerHTML = "";
  locations.forEach((loc, i) => {
    const div = document.createElement("div");
    div.className = "locationItem";
    div.textContent = loc.name;
    div.onclick = () => {
      target = loc;
      document.getElementById("helpPanel").classList.remove("open");
    };
    list.appendChild(div);
  });
}

// Hitung jarak
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
  const Δφ = (lat2-lat1) * Math.PI/180;
  const Δλ = (lon2-lon1) * Math.PI/180;
  const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Hitung arah
function getBearing(lat1, lon1, lat2, lon2) {
  const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
  const λ1 = lon1 * Math.PI/180, λ2 = lon2 * Math.PI/180;
  const y = Math.sin(λ2-λ1) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) -
            Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
  return (Math.atan2(y, x) * 180/Math.PI + 360) % 360;
}

// Update arah & jarak
function updateUI() {
  if (target && currentPos) {
    const dist = getDistance(currentPos.latitude, currentPos.longitude, target.lat, target.lon);
    const bearing = getBearing(currentPos.latitude, currentPos.longitude, target.lat, target.lon);
    const relativeBearing = (bearing - currentHeading + 360) % 360;
    document.getElementById("arrow").style.transform = `translateX(-50%) rotate(${relativeBearing}deg)`;
    document.getElementById("distance").textContent = `Jarak: ${dist.toFixed(1)} m`;
  }
}

// GPS watch
navigator.geolocation.watchPosition(pos => {
  currentPos = pos.coords;
  updateUI();
}, err => {
  alert("Gagal membaca lokasi: " + err.message);
}, { enableHighAccuracy: true });

// Kompas
window.addEventListener("deviceorientationabsolute", e => {
  if (e.alpha !== null) {
    currentHeading = e.alpha;
    updateUI();
  }
}, true);

// Tombol bantuan
document.getElementById("helpBtn").onclick = () => {
  document.getElementById("helpPanel").classList.toggle("open");
};

// Init
initCamera();
loadLocations();
</script>
</body>
</html>
