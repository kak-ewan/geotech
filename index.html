<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>GeoTech AR — Fix Kamera</title>

<!-- A-Frame & AR.js -->
<script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
<script src="https://rawcdn.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

<style>
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Roboto,Segoe UI;}
  a-scene{position:fixed;inset:0;width:100%;height:100%;z-index:0;}
  /* Overlays */
  .overlay { position: fixed; left: 0; right: 0; z-index: 2000; pointer-events: none; }
  .topbar { top: 10px; display:flex; justify-content:flex-end; gap:8px; padding:0 14px; pointer-events:auto; }
  .btn { pointer-events:auto; background: rgba(0,0,0,0.6); color:#fff; border:1px solid rgba(255,255,255,0.06); padding:8px 12px; border-radius:10px; cursor:pointer; }
  /* Start overlay */
  #startOverlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:3000; background:linear-gradient(180deg, rgba(0,0,0,0.85), rgba(0,0,0,0.6)); text-align:center; padding:20px; }
  #startOverlay .card { max-width:500px; color:#e6f0fb; }
  #debugBox { margin-top:14px; font-size:13px; color:#cfe7ff; text-align:left; max-height:180px; overflow:auto; background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; }
  /* Left panel */
  #leftPane { position:fixed; left:-92%; top:0; bottom:0; width:360px; max-width:88%; background:rgba(6,10,14,0.96); z-index:2100; transition:left .28s; padding:14px; pointer-events:auto; }
  #leftPane.open{left:0;}
  #locationList{list-style:none;padding:0;margin:12px 0 0 0;display:flex;flex-direction:column;gap:8px;}
  .loc{padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;display:flex;justify-content:space-between;align-items:center;}
  #arrow{position:fixed;left:50%;bottom:22vh;transform:translateX(-50%);z-index:2050;display:none;}
  #distanceBadge{position:fixed;left:50%;bottom:14vh;transform:translateX(-50%);background:rgba(0,0,0,0.6);padding:6px 10px;border-radius:999px;z-index:2050;display:none;}
  .small{font-size:13px;color:#a9c9e6;}
</style>
</head>
<body>
  <!-- A-Frame scene always present -->
  <a-scene embedded arjs="sourceType: webcam; gpsMinAccuracy: 50;" vr-mode-ui="enabled:false" renderer="logarithmicDepthBuffer: true;">
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <!-- Start overlay: user must press Start (user gesture) to request geolocation/orientation.
       We DO NOT call getUserMedia here to avoid conflicts with AR.js. AR.js will prompt camera. -->
  <div id="startOverlay">
    <div class="card">
      <h1 style="margin:0 0 8px 0">GeoTech AR — Mulai</h1>
      <div class="small">Tekan <strong>START</strong>, izinkan lokasi & orientasi. Setelah itu browser akan meminta izin kamera (biarkan).</div>
      <div style="margin-top:12px;">
        <button id="btnStart" class="btn">START</button>
        <button id="btnOpenList" class="btn" style="margin-left:8px">Bantuan</button>
      </div>
      <div id="debugBox" style="display:none"></div>
    </div>
  </div>

  <div class="overlay topbar" style="top:10px;">
    <div style="pointer-events:auto">
      <button id="toggleLeft" class="btn">Bantuan</button>
    </div>
  </div>

  <aside id="leftPane" aria-hidden="true">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div><h3 style="margin:0">Daftar Lokasi</h3><div class="small">Klik pilih untuk jadikan target</div></div>
      <div><button id="closeLeft" class="btn">Tutup</button></div>
    </div>

    <div style="margin-top:12px;">
      <input id="filter" placeholder="Cari..." style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff" />
    </div>

    <ul id="locationList"></ul>
  </aside>

  <div id="arrow" aria-hidden="true">
    <!-- simple arrow SVG -->
    <svg viewBox="0 0 64 64" width="96" height="96"><polygon points="32,2 54,34 36,34 36,62 28,62 28,34 10,34" fill="#06b6d4" opacity="0.95"/></svg>
  </div>
  <div id="distanceBadge" aria-hidden="true">— m</div>

<script>
/* Revised flow:
 - Do NOT call getUserMedia manually.
 - On START: request DeviceOrientation (iOS) and use navigator.geolocation.getCurrentPosition to trigger permission.
 - Loading overlay hides; AR.js will prompt camera for preview automatically (A-Frame/AR.js handles it).
 - If camera preview remains black after TIMEOUT_MS, show debugging tips.
*/

const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSCPrAyjTP4O7lSWJnouA4Ysnd5U88mcM-dWyJG0Nv9eWOA3yVKrGJ1-5G_QDdEcTNpwn0F5XbzeUJh/pub?gid=0&single=true&output=csv';
const TIMEOUT_MS = 8000; // wait camera init
const PROXIMITY = 20;

let pins = [], userPos = null, watchId = null, heading = null;
let selectedIndex = null;
const startOverlay = document.getElementById('startOverlay');
const debugBox = document.getElementById('debugBox');
const leftPane = document.getElementById('leftPane');
const locationList = document.getElementById('locationList');
const arrow = document.getElementById('arrow');
const distanceBadge = document.getElementById('distanceBadge');

function logDebug(...args){
  console.log(...args);
  debugBox.style.display = 'block';
  debugBox.textContent += args.map(a => (typeof a==='object' ? JSON.stringify(a) : String(a))).join(' ') + '\\n';
}

// Parse CSV (name,lat,lon,url)
function parseCSV(txt){
  txt = txt.replace(/^\\uFEFF/,'');
  const lines = txt.split(/\\r?\\n/).map(l=>l.trim()).filter(l=>l.length);
  if(!lines.length) return [];
  let start = 0;
  if(lines[0].toLowerCase().includes('name') && lines[0].toLowerCase().includes('lat')) start = 1;
  const rows = [];
  for(let i=start;i<lines.length;i++){
    const parts = lines[i].split(',');
    if(parts.length < 4) continue;
    const name = parts[0].trim();
    const lat = parseFloat(parts[1]);
    const lon = parseFloat(parts[2]);
    const url = parts.slice(3).join(',').trim();
    if(!name || isNaN(lat) || isNaN(lon) || !url) continue;
    rows.push({name,lat,lon,url});
  }
  return rows;
}
function detectType(url){
  const u = url.split('?')[0].toLowerCase();
  if(u.match(/\\.(glb|gltf)$/)) return 'model';
  if(u.match(/\\.(mp4|webm|ogg)$/)) return 'video';
  if(u.match(/\\.(png|jpg|jpeg|webp|gif)$/)) return 'image';
  return 'unknown';
}
function haversine(aLat,aLon,bLat,bLon){
  const toRad = v => v*Math.PI/180;
  const R = 6371000;
  const dLat = toRad(bLat-aLat), dLon = toRad(bLon-aLon);
  const lat1 = toRad(aLat), lat2 = toRad(bLat);
  const sinDlat = Math.sin(dLat/2), sinDlon = Math.sin(dLon/2);
  const a = sinDlat*sinDlat + Math.cos(lat1)*Math.cos(lat2)*sinDlon*sinDlon;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
function bearingTo(aLat,aLon,bLat,bLon){
  const toRad = v => v*Math.PI/180;
  const toDeg = v => v*180/Math.PI;
  const y = Math.sin(toRad(bLon-aLon)) * Math.cos(toRad(bLat));
  const x = Math.cos(toRad(aLat))*Math.sin(toRad(bLat)) - Math.sin(toRad(aLat))*Math.cos(toRad(bLat))*Math.cos(toRad(bLon-aLon));
  let brng = toDeg(Math.atan2(y,x));
  brng = (brng + 360) % 360;
  return brng;
}

// load CSV -> build pins and list & create AR entities
async function loadPins(){
  try {
    const res = await fetch(CSV_URL);
    const txt = await res.text();
    pins = parseCSV(txt).map(p => ({...p, type: detectType(p.url)}));
    logDebug('pins', pins.length);
    renderList();
    createAREntities(); // create gps-entities for pins
  } catch (e){
    logDebug('CSV fetch error', e);
    alert('Gagal memuat CSV: ' + e);
  }
}

function renderList(filter=''){
  locationList.innerHTML = '';
  pins.forEach((p,i)=>{
    if(filter && !(p.name + ' ' + p.url).toLowerCase().includes(filter.toLowerCase())) return;
    const li = document.createElement('li');
    li.className = 'loc';
    li.setAttribute('data-idx', i);
    li.innerHTML = '<div><div style="font-weight:700">'+escapeHtml(p.name)+'</div><div class="small">'+escapeHtml(p.type)+' · <span class="dist">—</span></div></div><div><button class="btn" data-idx="'+i+'">Pilih</button></div>';
    locationList.appendChild(li);
  });
  // attach
  locationList.querySelectorAll('button.btn').forEach(b=>{
    b.onclick = e => {
      const idx = Number(e.target.getAttribute('data-idx'));
      selectTarget(idx);
      leftPane.classList.remove('open');
    };
  });
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

// create gps-entity-place for each pin
function createAREntities(){
  const scene = document.querySelector('a-scene');
  if(!scene){ logDebug('no a-scene'); return; }
  // remove previous
  Array.from(scene.querySelectorAll('[gps-entity-place]')).forEach(x => x.remove());
  pins.forEach((p, idx) => {
    if (p.type === 'model'){
      const ent = document.createElement('a-entity');
      ent.setAttribute('gps-entity-place', `latitude: ${p.lat}; longitude: ${p.lon};`);
      ent.setAttribute('gltf-model', p.url);
      ent.setAttribute('scale', '1 1 1');
      ent.setAttribute('rotation','0 180 0');
      ent.setAttribute('animation-mixer','');
      scene.appendChild(ent);
    } else if (p.type === 'image'){
      const img = document.createElement('a-image');
      img.setAttribute('gps-entity-place', `latitude: ${p.lat}; longitude: ${p.lon};`);
      img.setAttribute('src', p.url);
      img.setAttribute('width','2');
      img.setAttribute('height','1.2');
      scene.appendChild(img);
    } else if (p.type === 'video'){
      // hidden video element as texture
      let vid = document.getElementById('video-pin-'+idx);
      if(!vid){
        vid = document.createElement('video');
        vid.id = 'video-pin-'+idx;
        vid.src = p.url;
        vid.setAttribute('playsinline','');
        vid.setAttribute('webkit-playsinline','');
        vid.muted = true;
        vid.loop = true;
        vid.crossOrigin = 'anonymous';
        vid.style.display = 'none';
        document.body.appendChild(vid);
      }
      const plane = document.createElement('a-plane');
      plane.setAttribute('gps-entity-place', `latitude: ${p.lat}; longitude: ${p.lon};`);
      plane.setAttribute('material', `shader: flat; src: #${vid.id}`);
      plane.setAttribute('width','2');
      plane.setAttribute('height','1.2');
      scene.appendChild(plane);
    }
  });
  logDebug('AR entities created');
}

function selectTarget(idx){
  selectedIndex = idx;
  document.querySelectorAll('.loc').forEach(li=> li.classList.toggle('selected', Number(li.getAttribute('data-idx'))===idx));
  document.getElementById('targetName').textContent = pins[idx].name;
  updateDistances(); updateArrow();
}

// update distances in list + distance badge
function updateDistances(){
  if(!userPos) return;
  document.querySelectorAll('.loc').forEach(li=>{
    const idx = Number(li.getAttribute('data-idx'));
    const p = pins[idx];
    const d = haversine(userPos.lat, userPos.lon, p.lat, p.lon);
    const el = li.querySelector('.dist');
    if(el) el.textContent = d >= 1000 ? (d/1000).toFixed(2)+' km' : Math.round(d)+' m';
  });
  if(selectedIndex !== null){
    const p = pins[selectedIndex];
    const d = haversine(userPos.lat, userPos.lon, p.lat, p.lon);
    distanceBadge.style.display = 'block';
    distanceBadge.textContent = d >= 1000 ? (d/1000).toFixed(2)+' km' : Math.round(d)+' m';
  }
}

// Arrow: uses heading if available
function updateArrow(){
  if(selectedIndex === null || !userPos) { arrow.style.display='none'; return; }
  const p = pins[selectedIndex];
  const brng = bearingTo(userPos.lat, userPos.lon, p.lat, p.lon);
  if(typeof heading === 'number'){
    const rot = (brng - heading + 360) % 360;
    arrow.style.display='block';
    arrow.style.transform = `translateX(-50%) rotate(${rot}deg)`;
  } else {
    arrow.style.display='block';
    arrow.style.transform = `translateX(-50%) rotate(${brng}deg)`;
  }
}

// watch position
function startWatch(){
  if(!navigator.geolocation) { logDebug('geolocation not supported'); return; }
  watchId = navigator.geolocation.watchPosition(pos=>{
    userPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    logDebug('pos', userPos);
    updateDistances(); updateArrow();
  }, err => {
    logDebug('watchPosition err', err);
    alert('Gagal mendapatkan lokasi: ' + (err.message || err.code));
  }, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
}

// orientation
function setupOrientation(){
  function enable(){
    window.addEventListener('deviceorientationabsolute', handleOrient, true);
    window.addEventListener('deviceorientation', handleOrient, true);
  }
  if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
    DeviceOrientationEvent.requestPermission().then(r=>{
      if(r==='granted'){ enable(); logDebug('orientation granted'); }
      else { logDebug('orientation denied'); }
    }).catch(err => { logDebug('orientation request err', err); enable(); });
  } else { enable(); }
}
function handleOrient(ev){
  let a = ev.alpha;
  if(a===null || a===undefined) return;
  const screenOrientation = (screen.orientation && screen.orientation.angle) || (window.orientation || 0);
  a = a - screenOrientation;
  heading = (a + 360) % 360;
  updateArrow();
}

// Play video (requires proximity)
function playVideoAt(idx){
  const p = pins[idx];
  if(!p || p.type !== 'video') return;
  if(!userPos) return alert('Lokasi perangkat belum tersedia.');
  const d = haversine(userPos.lat, userPos.lon, p.lat, p.lon);
  if(d > PROXIMITY) return alert('Dekati lokasi untuk memutar video (jarak sekarang ' + Math.round(d) + ' m).');
  const v = document.getElementById('video-pin-'+idx);
  if(!v) return alert('Video belum siap.');
  v.muted = false;
  v.play().catch(e => { logDebug('video play error', e); alert('Browser mungkin memblokir autoplay; sentuh layar untuk memulai.'); });
}

// START button flow: request geolocation/getCurrentPosition to trigger permissions and orientation; AR.js will prompt camera itself.
document.getElementById('btnStart').addEventListener('click', async () => {
  debugBox.textContent = '';
  logDebug('START pressed — requesting permissions...');
  // request orientation permission on iOS if needed
  setupOrientation();
  // request a single geolocation to trigger prompt
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      userPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
      logDebug('initial pos', userPos);
      setTimeout(()=> { // let AR.js try camera preview
        checkCameraPreview();
      }, 1500);
    }, err => {
      logDebug('getCurrentPosition error', err);
      alert('Izin lokasi diperlukan untuk navigasi.');
    }, { enableHighAccuracy:true, timeout:10000 });
    startWatch();
  } else {
    alert('Geolocation tidak tersedia.');
  }
  // load CSV and AR entities
  await loadPins();
  // hide start overlay now and let AR.js show camera
  startOverlay.classList.add('hidden');
  setTimeout(()=> { checkCameraPreview(); }, 1200);
});

// helper: check if camera video element used by AR.js is producing frames
function checkCameraPreview(){
  // try to find video element that AR.js uses (common selectors)
  const candidates = Array.from(document.querySelectorAll('video'));
  // pick the visible video that has width>0 and height>0 and readyState>1
  const v = candidates.find(x => {
    try {
      const r = x.readyState >= 2 && x.videoWidth > 10 && x.videoHeight > 10 && getComputedStyle(x).visibility !== 'hidden';
      return r;
    } catch(e){ return false; }
  });
  if(v){
    logDebug('Camera video found:', v, 'resolution', v.videoWidth, v.videoHeight);
    document.getElementById('debugBox').textContent += '\\nCamera ready — AR preview should be visible.';
    // good
    return true;
  } else {
    // not found — show friendly debugging tips
    setTimeout(()=> {
      const still = Array.from(document.querySelectorAll('video')).find(x => x.readyState >= 2);
      if(!still){
        const msg = [
          'AR preview belum terlihat. Hal yang perlu dicek:',
          '1) Pastikan halaman dibuka via HTTPS.',
          '2) Pastikan kamera situs diizinkan di browser (site settings).',
          '3) Di iOS Safari: izinkan "Motion & Orientation" dan kamera di Settings -> Safari -> Camera/Motion.',
          '4) Coba refresh dan tekan START lagi; periksa console (remote debug).'
        ].join('\\n');
        logDebug('Camera not ready — tips shown');
        alert(msg);
      } else {
        logDebug('Found video element with readyState but not visible yet.');
      }
    }, TIMEOUT_MS);
    return false;
  }
}

// small helpers
function setStatus(s){ document.getElementById('statusTiny').textContent = s; }

// UI wiring
document.getElementById('toggleLeft').addEventListener('click', ()=> leftPane.classList.toggle('open'));
document.getElementById('closeLeft').addEventListener('click', ()=> leftPane.classList.remove('open'));
document.getElementById('btnOpenList').addEventListener('click', ()=> leftPane.classList.toggle('open'));
document.getElementById('filter').addEventListener('input', e => renderList(e.target.value));

// auto-call loadPins to prepare entities early (AR entities can be created even before permissions)
loadPins();

</script>
</body>
</html>
