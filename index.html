<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>GeoTech AR</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.rawgit.com/jeromeetienne/AR.js/2.2.1/aframe/build/aframe-ar.js"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #000;
    overflow: hidden;
  }
  #errorMsg {
    color: white;
    font-size: 1.5em;
    text-align: center;
    padding: 20px;
  }
  #helpBtn {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    z-index: 1000;
  }
  #locationList {
    position: fixed;
    top: 0;
    left: -300px;
    width: 250px;
    height: 100%;
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 15px;
    box-sizing: border-box;
    transition: left 0.3s ease;
    z-index: 999;
    overflow-y: auto;
  }
  #locationList.open {
    left: 0;
  }
  .location-item {
    padding: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    cursor: pointer;
  }
  #arrow {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    z-index: 1000;
  }
</style>
</head>
<body>

<div id="errorMsg"></div>

<button id="helpBtn" style="display:none;">Bantuan</button>

<div id="locationList"></div>

<img id="arrow" src="https://cdn-icons-png.flaticon.com/512/32/32195.png" style="display:none;">

<a-scene id="arScene" embedded arjs="sourceType: webcam;" vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true;" style="display:none;">
</a-scene>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCPrAyjTP4O7lSWJnouA4Ysnd5U88mcM-dWyJG0Nv9eWOA3yVKrGJ1-5G_QDdEcTNpwn0F5XbzeUJh/pub?gid=0&single=true&output=csv";

let userLat = null, userLon = null;
let targetLat = null, targetLon = null;

async function init() {
  try {
    // Request lokasi
    await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        console.log("Lokasi awal:", userLat, userLon);
        resolve();
      }, err => {
        reject("Izin lokasi ditolak atau tidak tersedia.");
      }, { enableHighAccuracy: true });
    });

    // Request kamera (dummy stream untuk izin)
    await navigator.mediaDevices.getUserMedia({ video: true });

    document.getElementById("errorMsg").style.display = "none";
    document.getElementById("helpBtn").style.display = "block";
    document.getElementById("arrow").style.display = "block";
    document.getElementById("arScene").style.display = "block";

    loadCSVData();
    watchLocation();
  } catch (e) {
    document.getElementById("errorMsg").innerText = e;
    console.error(e);
  }
}

function watchLocation() {
  navigator.geolocation.watchPosition(pos => {
    userLat = pos.coords.latitude;
    userLon = pos.coords.longitude;
    updateArrow();
  }, err => {
    console.error("Error GPS:", err);
  }, { enableHighAccuracy: true });
}

function updateArrow() {
  if (targetLat && targetLon && userLat && userLon) {
    const y = bearing(userLat, userLon, targetLat, targetLon);
    document.getElementById("arrow").style.transform =
      `translateX(-50%) rotate(${y}deg)`;
  }
}

function bearing(lat1, lon1, lat2, lon2) {
  const toRad = d => d * Math.PI / 180;
  const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
  const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
            Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
  let brng = Math.atan2(y, x);
  brng = (brng * 180 / Math.PI + 360) % 360;
  return brng;
}

async function loadCSVData() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const rows = text.trim().split("\n").slice(1);
  const listDiv = document.getElementById("locationList");

  rows.forEach(row => {
    const [name, lat, lon, url] = row.split(",");
    const item = document.createElement("div");
    item.className = "location-item";
    item.textContent = name;
    item.onclick = () => {
      targetLat = parseFloat(lat);
      targetLon = parseFloat(lon);
      loadARObject(url, lat, lon);
    };
    listDiv.appendChild(item);
  });

  document.getElementById("helpBtn").onclick = () => {
    listDiv.classList.toggle("open");
  };
}

function loadARObject(url, lat, lon) {
  const scene = document.getElementById("arScene");
  // Hapus objek lama
  Array.from(scene.querySelectorAll("a-entity")).forEach(el => el.remove());

  if (url.endsWith(".glb")) {
    const model = document.createElement("a-entity");
    model.setAttribute("gps-entity-place", `latitude: ${lat}; longitude: ${lon}`);
    model.setAttribute("gltf-model", url);
    model.setAttribute("scale", "1 1 1");
    scene.appendChild(model);
  } else if (url.endsWith(".jpg") || url.endsWith(".png")) {
    const img = document.createElement("a-image");
    img.setAttribute("gps-entity-place", `latitude: ${lat}; longitude: ${lon}`);
    img.setAttribute("src", url);
    img.setAttribute("scale", "5 5 5");
    scene.appendChild(img);
  } else if (url.endsWith(".mp4") || url.endsWith(".webm")) {
    const dist = getDistance(userLat, userLon, parseFloat(lat), parseFloat(lon));
    if (dist <= 20) {
      const vid = document.createElement("video");
      vid.src = url;
      vid.controls = true;
      vid.autoplay = false;
      vid.setAttribute("style", "position:fixed;bottom:10px;left:50%;transform:translateX(-50%);z-index:1000;width:80%;");
      document.body.appendChild(vid);
    } else {
      alert("Dekati lokasi untuk memutar video.");
    }
  }
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = d => d * Math.PI / 180;
  const φ1 = toRad(lat1);
  const φ2 = toRad(lat2);
  const Δφ = toRad(lat2 - lat1);
  const Δλ = toRad(lon2 - lon1);
  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

init();
</script>
</body>
</html>
