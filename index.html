<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>GeoAR.js dengan Petunjuk Arah</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
      .debug-panel {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: Arial;
        z-index: 10000;
      }
      .direction-arrow {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 40px;
        color: red;
        z-index: 10000;
      }
    </style>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <div class="direction-arrow" id="directionArrow">↑</div>
    <div class="debug-panel" id="debugPanel">
      <div>Mencari lokasi...</div>
      <div id="distanceInfo">Jarak: -</div>
      <div id="directionInfo">Arah: -</div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: true;"
    >
      <!-- Objek target -->
      <a-box
        id="targetObject"
        look-at="[gps-camera]"
        scale="10 10 10"
        material="color: red; opacity: 0.9;"
        gps-entity-place="latitude: -8.6247; longitude: 116.1190;"
      ></a-box>
      
      <!-- Petunjuk arah (akan dibuat secara dinamis) -->
      <a-entity id="directionIndicator"></a-entity>
      
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const targetLat = -8.6247;
        const targetLng = 116.1190;
        let userLat, userLng;
        let arrowElement = document.getElementById('directionArrow');
        let distanceInfo = document.getElementById('distanceInfo');
        let directionInfo = document.getElementById('directionInfo');
        let debugPanel = document.getElementById('debugPanel');
        
        // Update posisi pengguna
        window.addEventListener('gps-camera-update-position', function(e) {
          userLat = e.detail.position.latitude;
          userLng = e.detail.position.longitude;
          
          // Hitung jarak dan arah
          const distance = calculateDistance(userLat, userLng, targetLat, targetLng);
          const bearing = calculateBearing(userLat, userLng, targetLat, targetLng);
          
          // Update UI
          distanceInfo.textContent = `Jarak: ${distance.toFixed(1)} meter`;
          directionInfo.textContent = `Arah: ${bearing.toFixed(1)}° dari Utara`;
          
          // Putar panah petunjuk arah
          arrowElement.style.transform = `translate(-50%, -50%) rotate(${bearing}deg)`;
          
          // Tampilkan debug info
          debugPanel.innerHTML = `
            <div>Posisi Anda: ${userLat.toFixed(6)}, ${userLng.toFixed(6)}</div>
            <div>Target: ${targetLat.toFixed(6)}, ${targetLng.toFixed(6)}</div>
            <div id="distanceInfo">Jarak: ${distance.toFixed(1)} meter</div>
            <div id="directionInfo">Arah: ${bearing.toFixed(1)}° dari Utara</div>
          `;
        });
        
        // Fungsi menghitung jarak (dalam meter)
        function calculateDistance(lat1, lon1, lat2, lon2) {
          const R = 6371e3; // Earth radius in meters
          const φ1 = lat1 * Math.PI/180;
          const φ2 = lat2 * Math.PI/180;
          const Δφ = (lat2-lat1) * Math.PI/180;
          const Δλ = (lon2-lon1) * Math.PI/180;
          
          const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                   Math.cos(φ1) * Math.cos(φ2) *
                   Math.sin(Δλ/2) * Math.sin(Δλ/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          
          return R * c;
        }
        
        // Fungsi menghitung arah (bearing)
        function calculateBearing(lat1, lon1, lat2, lon2) {
          const φ1 = lat1 * Math.PI/180;
          const φ2 = lat2 * Math.PI/180;
          const λ1 = lon1 * Math.PI/180;
          const λ2 = lon2 * Math.PI/180;
          
          const y = Math.sin(λ2-λ1) * Math.cos(φ2);
          const x = Math.cos(φ1)*Math.sin(φ2) -
                    Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
          const θ = Math.atan2(y, x);
          
          return (θ*180/Math.PI + 360) % 360;
        }
      });
    </script>
  </body>
</html>
